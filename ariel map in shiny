library(shiny)
library(mosaic)
library(tidyverse)
library(glue)
library(sf)
library(leaflet)
library(DT)

# Load data
preRoedata <- read_csv("OG_NationalAndStatePregnancy_PreDobbs_1988-2020.csv")
postRoedata <- read_csv("OG_MonthlyAbortionProvisionMonthly_2023-2024.csv")

# Pre-process data
preRoedata1 <- preRoedata %>%
  select(state, year, abortionstotal, abortionratetotal, abortionratiototal)

postRoedata$year <- year(mdy(postRoedata$month))

postRoedata1 <- postRoedata %>%
  select(state, year, median) %>%
  group_by(state, year) %>%
  summarize(abortionstotal = sum(median))

abortion_data <- full_join(preRoedata1, postRoedata1, by = c("state", "year"))

abortion_data1 <- abortion_data %>%
  mutate(abortionstotal = coalesce(abortionstotal.x, abortionstotal.y)) %>%
  select(-abortionstotal.x, -abortionstotal.y) %>%
  arrange(state, year)

# Load state geometry data
states <- sf::read_sf("https://rstudio.github.io/leaflet/json/us-states.geojson")

# Merge state names
statenames <- read_csv("state_names.csv") %>%
  select("State", "Alpha code")

states <- full_join(states, statenames, by = c("name" = "State"))

# Merge geometry with abortion data
abortion_data_geom <- left_join(abortion_data1, states, by = c("state" = "Alpha code"))

# Ensure geometry column exists and convert to sf object
abortion_data_geom <- st_as_sf(abortion_data_geom)

# UI
ui <- fluidPage(
  titlePanel("Abortion Data by State"),
  
  sidebarLayout(
    sidebarPanel(
      sliderInput("year", "Select Year:",
                  min = min(preRoedata$year),
                  max = max(postRoedata$year),
                  value = min(preRoedata$year),
                  step = 1,
                  sep = ""),
      
      selectInput("state", "State:",
                  choices = unique(abortion_data_geom$name)),
      
      hr(),
      
      helpText("This dashboard visualizes abortion data across the United States. Use the slider to select a year and the dropdown to choose a specific state.")
    ),
    
    mainPanel(
      tabsetPanel(
        tabPanel("Map", 
                 leafletOutput("map", height = "600px"),
                 hr(),
                 h4("About the Map"),
                 p("This map shows the abortion rate per 1,000 women aged 15-44 for each state. Darker colors indicate higher rates.")
        ),
        tabPanel("Data Table", 
                 h3("State-by-State Abortion Data"),
                 DT::dataTableOutput("stateTable"),
                 hr(),
                 h4("About the Data"),
                 p("This table provides detailed abortion statistics for each state in the selected year. You can sort and search the data using the table controls.")
        )
      )
    )
  )
)

# Server
server <- function(input, output, session) {
  
  bins <- c(0, 5, 10, 15, 20, 25, 30, 35, Inf)
  
  # Reactive filtered data based on selected year
  filtered_data <- reactive({
    abortion_data_geom %>%
      filter(year == input$year) %>%
      st_drop_geometry() # Drop geometry column for non-map use cases
  })
  
  # Map rendering
  output$map <- renderLeaflet({
    req(input$year)
    
    abortion_data_year <- abortion_data_geom %>%
      filter(year == input$year)
    
    pal <- colorBin("YlOrRd", domain = abortion_data_year$abortionratetotal, bins = bins)
    
    labels <- sprintf(
      "<strong>%s</strong><br/>%g abortions per 1,000 women",
      abortion_data_year$name, abortion_data_year$abortionratetotal
    ) %>% lapply(htmltools::HTML)
    
    leaflet(abortion_data_year) %>%
      setView(-96, 37.8, zoom = 4) %>%
      addProviderTiles(providers$CartoDB.Positron) %>%
      addPolygons(
        fillColor = ~pal(abortionratetotal),
        weight = 2,
        opacity = 1,
        color = "white",
        dashArray = "3",
        fillOpacity = 0.7,
        highlightOptions = highlightOptions(
          weight = 5,
          color = "#666",
          dashArray = "",
          fillOpacity = 0.7,
          bringToFront = TRUE),
        label = labels,
        labelOptions = labelOptions(
          style = list("font-weight" = "normal", padding = "3px 8px"),
          textsize = "15px",
          direction = "auto")) %>%
      addLegend(pal = pal, values = ~abortionratetotal, opacity = 0.7,
                title = "Abortion Rate", position = "bottomright")
  })
  
  # Data table rendering
  output$stateTable <- DT::renderDataTable({
    data <- filtered_data() %>%
      select(name, abortionratetotal, abortionstotal, abortionratiototal) %>%
      rename(State = name,
             `Abortion Rate` = abortionratetotal,
             `Total Abortions` = abortionstotal,
             `Abortion Ratio` = abortionratiototal)
    
    DT::datatable(data, options = list(pageLength = 10))
  })
}

shinyApp(ui = ui, server = server)
library(shiny)
library(mosaic)
library(tidyverse)
library(glue)
library(tidyverse)
library(sf)
library(leaflet)

preRoedata <- read_csv("OG_NationalAndStatePregnancy_PreDobbs_1988-2020.csv")
postRoedata <- read_csv("OG_MonthlyAbortionProvisionMonthly_2023-2024.csv")

preRoedata1 <- preRoedata %>%
  select(state, year, abortionstotal, abortionratetotal, abortionratiototal)

postRoedata$year <- year(mdy(postRoedata$month))

postRoedata1 <- postRoedata %>%
  select(state, year, median) %>%
  group_by(state, year) %>%
  summarize(abortionstotal = sum(median))

abortion_data <- full_join(preRoedata1, postRoedata1, by = c("state", "year"))

abortion_data1 <- abortion_data %>%
  mutate(abortionstotal = coalesce(abortionstotal.x, abortionstotal.y)) %>%
  select(-abortionstotal.x, -abortionstotal.y) %>%
  arrange(state, year)

# Data (to get geometry variable)
states <- sf::read_sf("https://rstudio.github.io/leaflet/json/us-states.geojson")

# Merge on name/state name variable
statenames <- read_csv("state_names.csv")

statenames <- statenames %>%
  select("State", "Alpha code")

states <- full_join(states, statenames, by = c("name" = "State"))

abortion_data_geom <- left_join(abortion_data1, states, by = c("state" = "Alpha code"))

# Ensure geometry column exists and convert abortion_data_geom to an sf object
abortion_data_geom <- st_as_sf(abortion_data_geom)
  
# UI
ui <- fluidPage(
  titlePanel("Abortion Data by State"),
  
  sidebarLayout(
    sidebarPanel(
      sliderInput("year", "Select Year:",
                  min = min(preRoedata$year, postRoedata$year),
                  max = max(preRoedata$year, postRoedata$year),
                  value = min(preRoedata$year, postRoedata$year),
                  step = 1,
                  sep = ""),
      
      selectInput("state", "State:",
                  choices = unique(abortion_data_geom$name))
    ),
    
    mainPanel(
      leafletOutput("map", height = "600px")
    )
  )
)


# Server
server <- function(input, output, session) {
  
  # Define color bins
  bins <- c(0, 5, 10, 15, 20, 25, 30, 35, Inf)
  
  output$map <- renderLeaflet({
    req(input$year)
    
    
    abortion_data_year <- abortion_data_geom %>%
      filter(year == input$year)
    
    # Create color palette
    pal <- colorBin("YlOrRd", domain = abortion_data_year$abortionratetotal, bins = bins)
    
    labels <- sprintf(
      "<strong>%s</strong><br/>%g abortions",
      abortion_data_year$name, abortion_data_year$abortionratetotal
    ) %>% lapply(htmltools::HTML)
    
    leaflet(abortion_data_year) %>%
      setView(-96, 37.8, 4) %>%
      addProviderTiles("MapBox", options = providerTileOptions(
        id = "mapbox.light",
        accessToken = Sys.getenv('MAPBOX_ACCESS_TOKEN'))) %>%
      addPolygons(
        fillColor = ~pal(abortionratetotal),
        weight = 2,
        opacity = 1,
        color = "white",
        dashArray = "3",
        fillOpacity = 0.7,
        highlightOptions = highlightOptions(
          weight = 5,
          color = "#666",
          dashArray = "",
          fillOpacity = 0.7,
          bringToFront = TRUE),
        label = labels,
        labelOptions = labelOptions(
          style = list("font-weight" = "normal", padding = "3px 8px"),
          textsize = "15px",
          direction = "auto")) %>%
      addLegend(pal = pal, values = ~abortionratetotal, opacity = 0.7, title = "Abortion Rate",
                position = "bottomright")
  })
}


shinyApp(ui = ui, server = server)
